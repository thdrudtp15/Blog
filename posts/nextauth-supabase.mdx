---
title: 'NextAuth + Supabase로 소셜 로그인 구현하기'
description: 'NextAuth와 Supabase를 이용한 소셜 로그인 구현 가이드입니다.'
date: '2025-09-18'
tags: ['NextAuth', 'Supabase']
cover: /post/covers/nextauth-supabase.png
---

# NextAuth + Supabase 소셜 로그인 구현 가이드

아버지의 회사 웹사이트에서 **관리자 로그인**이 필요해 NextAuth와 Supabase를 사용해 소셜 로그인을 구현했습니다. 이 가이드는 Supabase 데이터베이스가 이미 생성되어 있다는 가정하에 작성되었습니다.

## 1. NextAuth 설치

```bash
npm install next-auth
```

## 2. NextAuth 기본 설정

`/pages/api/auth/[...nextauth].js` 파일 생성 후:

```typescript
import NextAuth from 'next-auth';

export const authOptions = {
    providers: [],
};

export default NextAuth(authOptions);
```

## 3. Supabase 연동 라이브러리 설치

```bash
npm install @supabase/supabase-js @auth/supabase-adapter
```

## 4. 환경변수 설정

Supabase 프로젝트 URL과 Service Role Key를 `.env.local`에 추가:

```
SUPABASE_URL=******
SUPABASE_SERVICE_ROLE_KEY=********
```

-   Supabase 프로젝트 URL 확인 방법:
    ![supabase-url](/post/images/nextauth-supabase/url.png)
-   Secret Key 확인 방법:
    ![supabase-secret-key](/post/images/nextauth-supabase/secret.png)

## 5. Supabase 테이블 스키마 및 RLS 설정

> **Row Level Security(RLS)**
>
> -   Postgres에서 제공하는 행 단위 접근 제어 기능입니다.
> -   Supabase에서 사용자가 **자기 데이터만** 읽고 수정할 수 있도록 적용할 수 있습니다.

SQL Editor에서 다음 SQL 실행:

<details>
  <summary>
   <strong style={{textDecoration : "underline"}}>SQL문 보기 (클릭)</strong>
  </summary>

```sql
CREATE SCHEMA next_auth;

GRANT USAGE ON SCHEMA next_auth TO service_role;
GRANT ALL ON SCHEMA next_auth TO postgres;

CREATE TABLE IF NOT EXISTS next_auth.users (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text,
  email text,
  "emailVerified" timestamp with time zone,
  image text,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT email_unique UNIQUE (email)
);

GRANT ALL ON TABLE next_auth.users TO postgres;
GRANT ALL ON TABLE next_auth.users TO service_role;

CREATE FUNCTION next_auth.uid() RETURNS uuid
LANGUAGE sql STABLE AS $$
  select coalesce(
    nullif(current_setting('request.jwt.claim.sub', true), ''),
    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'sub')
  )::uuid
$$;

CREATE TABLE IF NOT EXISTS next_auth.sessions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  expires timestamp with time zone NOT NULL,
  "sessionToken" text NOT NULL,
  "userId" uuid,
  CONSTRAINT sessions_pkey PRIMARY KEY (id),
  CONSTRAINT sessionToken_unique UNIQUE ("sessionToken"),
  CONSTRAINT "sessions_userId_fkey" FOREIGN KEY ("userId")
    REFERENCES next_auth.users (id)
    ON UPDATE NO ACTION
    ON DELETE CASCADE
);

GRANT ALL ON TABLE next_auth.sessions TO postgres;
GRANT ALL ON TABLE next_auth.sessions TO service_role;

CREATE TABLE IF NOT EXISTS next_auth.accounts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  type text NOT NULL,
  provider text NOT NULL,
  "providerAccountId" text NOT NULL,
  refresh_token text,
  access_token text,
  expires_at bigint,
  token_type text,
  scope text,
  id_token text,
  session_state text,
  oauth_token_secret text,
  oauth_token text,
  "userId" uuid,
  CONSTRAINT accounts_pkey PRIMARY KEY (id),
  CONSTRAINT provider_unique UNIQUE (provider, "providerAccountId"),
  CONSTRAINT "accounts_userId_fkey" FOREIGN KEY ("userId")
    REFERENCES next_auth.users (id)
    ON UPDATE NO ACTION
    ON DELETE CASCADE
);

GRANT ALL ON TABLE next_auth.accounts TO postgres;
GRANT ALL ON TABLE next_auth.accounts TO service_role;

CREATE TABLE IF NOT EXISTS next_auth.verification_tokens (
  identifier text,
  token text,
  expires timestamp with time zone NOT NULL,
  CONSTRAINT verification_tokens_pkey PRIMARY KEY (token),
  CONSTRAINT token_unique UNIQUE (token),
  CONSTRAINT token_identifier_unique UNIQUE (token, identifier)
);

GRANT ALL ON TABLE next_auth.verification_tokens TO postgres;
GRANT ALL ON TABLE next_auth.verification_tokens TO service_role;
```

</details>

-   Exposed schemas에 `next_auth` 추가  
    ![exposed-schema](/post/images/nextauth-supabase/exposed.png)

## 6. NextAuth 세션에서 Supabase JWT 생성

```bash
npm install jsonwebtoken
```

### `[...nextauth].js` 예시 (구글)

```typescript
import NextAuth from 'next-auth';
import { SupabaseAdapter } from '@next-auth/supabase-adapter';
import GoogleProvider from 'next-auth/providers/google';
import jwt from 'jsonwebtoken';

export const authOptions = {
    // 구글 프로바이더 (필요한 소셜로그인 프로바이더를 설정)
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
    ],
    // 쿠키 설정
    cookies: {
        sessionToken: {
            name: `${
                process.env.NODE_ENV === 'production' ? '__Host-' : ''
            }next-auth.session-token`,
            options: {
                httpOnly: true,
                sameSite: 'lax',
                path: '/',
                secure: process.env.NODE_ENV === 'production',
            },
        },
    },
    callbacks: {
        // 로그인 시도 시 수행할 로직
        async signIn({ user }) {
            const allowedEmails = process.env.ALLOWED_EMAILS!.split(',');
            return user.email && allowedEmails.includes(user.email);
        },
        // getServerSession, useSession 사용 시 반환할 내용 정의
        async session({ session, user }) {
            const signingSecret = process.env.SUPABASE_JWT_SECRET;
            if (signingSecret) {
                const payload = {
                    aud: 'authenticated',
                    exp: Math.floor(new Date(session.expires).getTime() / 1000),
                    sub: user.id,
                    email: user.email,
                    role: 'authenticated',
                };
                session.supabaseAccessToken = jwt.sign(payload, signingSecret);
            }
            return session;
        },
    },
    // 수파베이스 어뎁터
    adapter: SupabaseAdapter({
        url: process.env.SUPABASE_URL!,
        secret: process.env.SUPABASE_SERVICE_ROLE_KEY!,
    }),
};

export default NextAuth(authOptions);
```

## 7. 로그인

NextAuth의 로그인과 로그아웃은 `signIn`, `signOut` 함수로 제어할 수 있습니다.  
이 함수들은 클라이언트 사이드에서만 작동합니다.

```typescript
import { signIn, signOut, useSession } from 'next-auth/react';
import React from 'react';

export default function LoginExample() {
    // 현재 로그인 상태 확인, 사용자 정보를 가져올 수 있다.
    const { data: session } = useSession();

    return (
        <div>
            {session && <button onClick={signIn}>로그인</button>}
            {!session && <button onClick={signOut}>로그아웃</button>}
        </div>
    );
}
```

> ⚠️ 주의
>
> -   이 함수들은 브라우저 환경에서만 작동하며, 서버사이드에서 호출하면 동작하지 않습니다.
> -   Next.js에서 SSR이나 API route에서 로그인/로그아웃 처리할 때는 `unstable_getServerSession()`을 사용해야 합니다.
